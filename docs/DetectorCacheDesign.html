<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>A Hopf, Skip and a Jump: DetectorCache design: mapping SlidingBuffer onto a 2-D structure.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">A Hopf, Skip and a Jump
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">DetectorCache design: mapping SlidingBuffer onto a 2-D structure. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="el" href="classslidingbuffer_1_1SlidingBuffer.html">SlidingBuffer</a> provides local caching of a data stream, but a <a class="el" href="classDetectorBank.html" title="Use multiple detectors to find note onsets at given frequencies (with multithreading). ">DetectorBank</a> operates by being initialised with audio data then, on successive calls, producing arrays of complex data.</p>
<p>Each row in such array contains the state locus of a Hopf system's complex variable. For an onset detector to work consistently and reliably, once a note is detected, the output of a channel has to backtrack to the note start by following the rising edge of a detector's output back to its origin.</p>
<p><a class="el" href="classdetectorcache_1_1DetectorCache.html" title="Cache results from a detectorbank. ">detectorcache::DetectorCache</a> wraps a sliding buffer to permit easy access to individual channels, and provides the method <a class="el" href="classdetectorcache_1_1Producer.html" title="Specialisation of the slidingbuffer::SegmentProducer class to create blocks of DetectorBank analysis ...">detectorcache::Producer</a> to interface between a <a class="el" href="classDetectorBank.html" title="Use multiple detectors to find note onsets at given frequencies (with multithreading). ">DetectorBank</a> that has already been initialised with audio samples and the DetectorCache's segments as they require more data. <a class="el" href="classDetectorBank.html#a416bb9650c4fc16f7e1a451099526eaf" title="Get the next numFrames of detector bank output. ">DetectorBank::getZ</a> is called to produce the complex data, then the absolute values of the returned results are taken and used to populate the segments.</p>
<p>To retain compatibility with the Python's numerical libraries, 2D arrays are allocated in C++ as a single area containing (channels*blocksize) result_t values. The API presented by a DetectorCache needs to change this view to individual channels, caching a given number of samples in each.</p>
<p>The type of SlidingBuffer used to achieve this is defined extending <a class="el" href="classslidingbuffer_1_1SlidingBuffer.html" title="SlidingBuffer is class template which can be used when reading a data stream to provide access to the...">slidingbuffer::SlidingBuffer</a> like this:</p>
<div class="fragment"><div class="line"><a class="code" href="classdetectorcache_1_1DetectorCache.html#a884662f6787e41ea8d31cf3b7460d670">detectorcache::DetectorCache::DetectorCache</a>(<span class="keyword">const</span> std::size_t num_segs,</div><div class="line">                                            <span class="keyword">const</span> std::size_t a_samps,</div><div class="line">                                            <a class="code" href="classdetectorcache_1_1Producer.html">detectorcache::Producer</a>&amp; p)</div><div class="line">    : <a class="code" href="namespaceslidingbuffer.html">slidingbuffer</a>::SlidingBuffer&lt;result_t *,</div><div class="line">                                   <a class="code" href="namespacedetectorcache.html">detectorcache</a>::Segment,</div><div class="line">                                   <a class="code" href="namespacedetectorcache.html">detectorcache</a>::Producer&gt;</div><div class="line">        (num_segs,</div><div class="line">         p.getChans(),</div><div class="line">         p)</div></div><!-- fragment --><p>Note that each segment of the siding buffer is an instance of <a class="el" href="classdetectorcache_1_1Segment.html" title="The producer class enabling a slidingbuffer::SlidingBuffer to be deployed as a cache for the two-dime...">detectorcache::Segment</a> (specialised Segment class in the detectorbank namespace) and its size is the number of channels supported by the <a class="el" href="classdetectorcache_1_1Producer.html" title="Specialisation of the slidingbuffer::SegmentProducer class to create blocks of DetectorBank analysis ...">detectorcache::Producer</a> (determined in turn from the <a class="el" href="classDetectorBank.html" title="Use multiple detectors to find note onsets at given frequencies (with multithreading). ">DetectorBank</a> with which the Producer was constructed).</p>
<p>A consequence of performing fixed-length block requests to <code>getZ</code> is that the SlidingBuffer base class can not in fact storing channels; it is instead storing pointers to blocks of result_t data representing a single block of one channel as shown in the following diagram.</p>
<p>Now that the data accessed through a DetectorCache is essentially 2D, the <code>[]</code> operator can no longer be used, at least without the overhead of a proxy class (C++11 mandates a single argument). Two access methods are therefore provided. <a class="el" href="classdetectorcache_1_1DetectorCache.html#ab9f09224d14adebb7d0f648f196b4f63">getResultItem</a> returns the value of a single item at a given sample position <code>n</code> in channel <code>c</code>; <a class="el" href="classdetectorcache_1_1DetectorCache.html#abcfe29f077f8ef6bee4c9a8f90a7ff18">getPreviousResults</a> fills a given 1D array by copying historical data from the DetectorCache. The resulting array holds consecutive samples of data in contiguous memory locations even if the original data is spread across the blocks associated with different segments. The specified data <em>ends</em> with the currentSample, and the given number of previous results are copied.</p>
<p><div class="dotgraph">
<img src="dot_range-copy.png" alt="dot_range-copy.png" border="0" usemap="#dot_range-copy.map"/>
<map name="dot_range-copy.map" id="dot_range-copy.map"></map>
<div class="caption">
Using a SlidingBuffer to implement a DetectorCache</div>
</div>
</p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
