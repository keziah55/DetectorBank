<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>A Hopf, Skip and a Jump: Python examples</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">A Hopf, Skip and a Jump
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Python examples </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Some short Python examples to illustrate basic use of the <a class="el" href="classDetectorBank.html#a416bb9650c4fc16f7e1a451099526eaf">getZ</a> and <a class="el" href="classDetectorBank.html#a3a7c0cc32a2d725bf9663b3a2e6365f9">absZ</a> methods, the <a class="el" href="classdetectorcache_1_1DetectorCache.html">DetectorCache</a>, the <a class="el" href="classOnsetDetector.html">OnsetDetector</a> and the <a class="el" href="PythonUsage.html#FrequencyShifter">FrequencyShifter</a>.</p>
<h1><a class="anchor" id="SimpleExample"></a>
Simple Example</h1>
<div class="fragment"><div class="line"><span class="stringliteral">&#39;&#39;&#39; Simple example to read in a file, create a DetectorBank with two octaves</span></div><div class="line"><span class="stringliteral">    of detectors and plot the abs(z) values.</span></div><div class="line"><span class="stringliteral">&#39;&#39;&#39;</span></div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> scipy.io.wavfile</div><div class="line"><span class="keyword">from</span> detectorbank <span class="keyword">import</span> DetectorBank</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"> </div><div class="line"><span class="comment"># read audio from file</span></div><div class="line"><span class="comment"># the sample rate should be 48000 or 44100</span></div><div class="line">sr, audio = scipy.io.wavfile.read(<span class="stringliteral">&#39;file.wav&#39;</span>)</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> audio.dtype == <span class="stringliteral">&#39;int16&#39;</span>:</div><div class="line">    audio = audio / 2**15</div><div class="line"></div><div class="line"><span class="comment"># array of frequencies (two octaves around A4)</span></div><div class="line">f = np.array(list(440 * 2**(k/12) <span class="keywordflow">for</span> k <span class="keywordflow">in</span> range(-12, 13)))</div><div class="line"><span class="comment"># minimum bandwidth detectors</span></div><div class="line">bandwidth = np.zeros(len(f))</div><div class="line"><span class="comment"># make 2D array of frequencies and bandwidths</span></div><div class="line">det_char = np.array(list(zip(f, bandwidth)))</div><div class="line"></div><div class="line"><span class="comment"># detectorbank  parameters</span></div><div class="line">method = DetectorBank.runge_kutta</div><div class="line">f_norm = DetectorBank.freq_unnormalized</div><div class="line">a_norm = DetectorBank.amp_normalized</div><div class="line">damping = 0.0001</div><div class="line">gain = 25</div><div class="line"> </div><div class="line"><span class="comment"># create DetectorBank object with sample rate sr, 32-bit float input audio,  </span></div><div class="line"><span class="comment"># 4 threads, detector characteristics det_char, using Runge-Kutta, without</span></div><div class="line"><span class="comment"># frequency normalisation and with amplitude normalisation, damping = 0.0001</span></div><div class="line"><span class="comment"># and with a gain of 25</span></div><div class="line">det = <a class="code" href="classDetectorBank.html">DetectorBank</a>(sr, audio.astype(np.float32), 4, det_char, </div><div class="line">                   method|f_norm|a_norm, damping, gain)</div><div class="line"></div><div class="line"><span class="comment"># create empty output array</span></div><div class="line">z = np.zeros((len(f),len(audio)), dtype=np.complex128)  </div><div class="line"><span class="comment"># fill z with detector output</span></div><div class="line">det.getZ(z)</div><div class="line"></div><div class="line"><span class="comment"># fill new array r with the absolute values of the z array</span></div><div class="line">r = np.zeros(z.shape)</div><div class="line">m = det.absZ(r, z)</div><div class="line">print(<span class="stringliteral">&#39;Max: {}&#39;</span>.format(m))</div><div class="line"></div><div class="line"><span class="comment"># plot the absZ values</span></div><div class="line">t = np.linspace(0, r.shape[1]/sr, r.shape[1])</div><div class="line"><span class="keywordflow">for</span> k <span class="keywordflow">in</span> range(r.shape[0]):</div><div class="line">    line, = plt.plot(t,r[k])</div><div class="line">plt.show()</div></div><!-- fragment --><h1><a class="anchor" id="DetectorCacheExample"></a>
Using the DetectorCache</h1>
<p>The previous example required all of the z values to be kept in RAM. For long audio files and/or many detectors, this is impractical. The <a class="el" href="classdetectorcache_1_1DetectorCache.html">DetectorCache</a> enables you to store a number of short segments of abs(z) values. If you request a value not currently in the cache, old segments will be deleted and new ones created until the requested sample is reached. This means the DetectorCache can only go forwards: once a segment has been deleted, attempting to access values from it will cause an exception to be thrown. (For more information, please see <a class="el" href="index.html#SlidingBuffer">SlidingBuffer</a>.) </p><div class="fragment"><div class="line"><span class="stringliteral">&#39;&#39;&#39; DetectorCache example: create a DetectorBank and use a DetectorCache to </span></div><div class="line"><span class="stringliteral">    access abs(z) values on demand.</span></div><div class="line"><span class="stringliteral">&#39;&#39;&#39;</span></div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> scipy.io.wavfile</div><div class="line"><span class="keyword">from</span> detectorbank <span class="keyword">import</span> DetectorBank, Producer, DetectorCache</div><div class="line"> </div><div class="line"><span class="comment"># read audio from file</span></div><div class="line"><span class="comment"># the sample rate should be 48000 or 44100</span></div><div class="line">sr, audio = scipy.io.wavfile.read(<span class="stringliteral">&#39;file.wav&#39;</span>)</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> audio.dtype == <span class="stringliteral">&#39;int16&#39;</span>:</div><div class="line">    audio = audio / 2**15</div><div class="line"></div><div class="line"><span class="comment"># array of frequencies (Hertz)</span></div><div class="line">f = np.array(list(440 * 2 ** (k/12) <span class="keywordflow">for</span> k <span class="keywordflow">in</span> range(-5,5)))</div><div class="line">bandwidth = np.zeros(len(f))</div><div class="line"><span class="comment"># change the bandwidth of the last detector</span></div><div class="line">bandwidth[2] = 7</div><div class="line"><span class="comment"># make 2D array of frequencies and bandwidths</span></div><div class="line">det_char = np.array(list(zip(f, bandwidth)))</div><div class="line">         </div><div class="line"><span class="comment"># detectorbank  parameters</span></div><div class="line">method = DetectorBank.runge_kutta</div><div class="line">f_norm = DetectorBank.freq_unnormalized</div><div class="line">a_norm = DetectorBank.amp_normalized</div><div class="line">damping = 0.0001</div><div class="line">gain = 25</div><div class="line"> </div><div class="line"><span class="comment"># construct DetectorBank</span></div><div class="line">det = <a class="code" href="classDetectorBank.html">DetectorBank</a>(sr, audio.astype(np.float32), 0, det_char,</div><div class="line">                   method|f_norm|a_norm, damping, gain)</div><div class="line"></div><div class="line"><span class="comment"># make a producer</span></div><div class="line">p = Producer(det)</div><div class="line"></div><div class="line"><span class="comment"># 2 segments, each containing sr (48000) abs(z) values</span></div><div class="line">cache = DetectorCache(p, 2, sr)</div><div class="line"></div><div class="line"><span class="comment"># get the first abs(z) value from channel five</span></div><div class="line">result = cache[5,0]</div><div class="line">print(result)</div><div class="line"></div><div class="line"><span class="comment"># get the 100000th value from channel seven</span></div><div class="line"><span class="comment"># this causes a new segment to be generated (100000 &gt; 2*sr)</span></div><div class="line">result = cache[7,100000]</div><div class="line">print(result)</div><div class="line"></div><div class="line"><span class="comment"># attempting to access a value from the (now discarded) first segment will </span></div><div class="line"><span class="comment"># cause the following exception to be thrown:</span></div><div class="line"><span class="comment"># IndexError: SlidingBuffer: Indexed item no longer available (underflow)</span></div><div class="line"><span class="keywordflow">try</span>:</div><div class="line">    result = cache[3,1000]</div><div class="line"><span class="keywordflow">except</span> IndexError <span class="keyword">as</span> err:</div><div class="line">    print(<span class="stringliteral">&#39;Attempting to access a value from a discarded segment throws an exception:&#39;</span>)</div><div class="line">    print(<span class="stringliteral">&#39;IndexError: {}&#39;</span>.format(err))</div></div><!-- fragment --><h1><a class="anchor" id="SaveLoadXMLExmaple"></a>
Saving and Loading DetectorBank Profiles</h1>
<p>The <a class="el" href="index.html#DetectorBank">DetectorBank</a> has a facility to save itself, so it can be reloaded, instead of constructing a new <a class="el" href="classDetectorBank.html" title="Use multiple detectors to find note onsets at given frequencies (with multithreading). ">DetectorBank</a> with the same parameters. </p><div class="fragment"><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">from</span> detectorbank <span class="keyword">import</span> DetectorBank</div><div class="line"></div><div class="line"><span class="comment"># array of frequencies (corresponding to 88 key piano)</span></div><div class="line">f = np.array(list(440 * 2**(k/12) <span class="keywordflow">for</span> k <span class="keywordflow">in</span> range(-48, 40)))</div><div class="line">bandwidth = np.zeros(len(f))</div><div class="line">det_char = np.array(list(zip(f, bandwidth)))</div><div class="line"></div><div class="line"><span class="comment"># detectorbank  parameters</span></div><div class="line">sr = 48000</div><div class="line">method = DetectorBank.runge_kutta</div><div class="line">f_norm = DetectorBank.freq_unnormalized</div><div class="line">a_norm = DetectorBank.amp_normalized</div><div class="line">damping = 0.0001</div><div class="line">gain = 25</div><div class="line"></div><div class="line"><span class="comment"># construct a DetectorBank, giving an empty array as input</span></div><div class="line">det = <a class="code" href="classDetectorBank.html">DetectorBank</a>(sr, np.zeros(1).astype(np.float32), 0, det_char, </div><div class="line">                   method|f_norm|a_norm, damping, gain)</div><div class="line"></div><div class="line"><span class="comment"># save the DetectorBank as &#39;88 key piano, RK4, f un, a nrm&#39;</span></div><div class="line">det.saveProfile(<span class="stringliteral">&#39;88 key piano, RK4, f un, a nrm&#39;</span>)</div></div><!-- fragment --><p> This profile can then be loaded into a new program thus: </p><div class="fragment"><div class="line"><span class="comment"># load new audio file</span></div><div class="line">sr, audio = scipy.io.wavfile.read(<span class="stringliteral">&#39;file.wav&#39;</span>)</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> audio.dtype == <span class="stringliteral">&#39;int16&#39;</span>:</div><div class="line">    audio = audio / 2**15</div><div class="line"> </div><div class="line"><span class="comment"># construct a DetectorBank from the saved profile</span></div><div class="line">det = db.DetectorBank(<span class="stringliteral">&#39;88 key piano, RK4, f un, a nrm&#39;</span>, audio.astype(np.float32))</div></div><!-- fragment --> <h1><a class="anchor" id="FrequencyShifterExample"></a>
Using the FrequencyShifter</h1>
<p>This package also contains a <a class="el" href="classFrequencyShifter.html" title="Shift a signal by a given frequency. ">FrequencyShifter</a>. You probably won't need to use it in conjunction with a <a class="el" href="classDetectorBank.html" title="Use multiple detectors to find note onsets at given frequencies (with multithreading). ">DetectorBank</a> (it will be applied automatically, if necessary), but it may be useful in other applications, so here's a short usage example. (Full explantion of the operation of the <a class="el" href="classFrequencyShifter.html" title="Shift a signal by a given frequency. ">FrequencyShifter</a> can be found <a class="el" href="FrequencyShifterOperation.html">here</a>.) </p><div class="fragment"><div class="line"><span class="stringliteral">&#39;&#39;&#39; FrequencyShifter example: create a sine tone at a given frequency, then</span></div><div class="line"><span class="stringliteral">    modulate it and plot the power spectral density of both signals.</span></div><div class="line"><span class="stringliteral">&#39;&#39;&#39;</span></div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">from</span> detectorbank <span class="keyword">import</span> FrequencyShifter</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"></div><div class="line">sr = 48000</div><div class="line"><span class="comment"># original signal frquency</span></div><div class="line">f0 = 10000</div><div class="line"><span class="comment"># amount by which to shift the signal</span></div><div class="line">f_shift = -7000</div><div class="line"></div><div class="line"><span class="comment"># create sine tone</span></div><div class="line">t = np.linspace(0, 2*np.pi*f0, sr)</div><div class="line">signal = np.sin(t)</div><div class="line">signal = signal.astype(np.float32)</div><div class="line"></div><div class="line"><span class="comment"># create empty array to be filled with the shifted signal</span></div><div class="line">shifted = np.zeros(signal.shape, dtype=np.float32)</div><div class="line"><span class="comment"># make FrequencyShifter which uses FIR</span></div><div class="line">fs = <a class="code" href="classFrequencyShifter.html">FrequencyShifter</a>(signal, sr, FrequencyShifter.fir)</div><div class="line"><span class="comment"># shift the signal by the stated frequency</span></div><div class="line">fs.shift(f_shift, shifted)</div><div class="line"></div><div class="line"><span class="comment"># the FrequencyShifter can be reused to modulate the same signal multiple times</span></div><div class="line"><span class="comment">#shifted2 = np.zeros(signal.shape, dtype=np.float32)</span></div><div class="line"><span class="comment">#fs.shift(5000, shifted2)</span></div><div class="line"></div><div class="line"><span class="comment"># plot power spectral density curves for the original and shifted signals</span></div><div class="line">f, (ax1, ax2) = plt.subplots(2, sharex=<span class="keyword">True</span>)</div><div class="line">ax1.psd(signal, Fs=sr)</div><div class="line">ax1.set_xlim(xmax=sr//2)</div><div class="line">ax1.set_ylim(-120, -20)</div><div class="line">ax1.set_xlabel(<span class="stringliteral">&#39;&#39;</span>)</div><div class="line">ax1.set_ylabel(<span class="stringliteral">&#39;dB/Hz&#39;</span>)</div><div class="line">ax2.psd(shifted, Fs=sr)</div><div class="line">ax2.set_xlim(xmax=sr//2)</div><div class="line">ax2.set_ylim(-120, -20)</div><div class="line">ax2.set_ylabel(<span class="stringliteral">&#39;dB/Hz&#39;</span>)</div><div class="line">plt.show()</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
